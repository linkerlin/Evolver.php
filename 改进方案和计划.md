# Evolver.php 改进方案与计划

## 概述

本文档基于对 zhichai 上 [EvoMap/evolver 深度技术研究报告](https://zhichai.top/topic/177168577) 的深入理解，对照当前 Evolver.php 项目实现，找出其中的错误和不足之处，并制定详细的改进方案和计划。

---

## 一、GEP 协议合规性分析与改进

### 1.1 当前问题：Asset ID 生成机制缺失

**问题描述：**
根据 GEP 协议规范，Gene 和 Capsule 必须使用 **SHA-256 内容寻址** 生成 `asset_id`，格式为 `sha256:<64位十六进制>`。当前实现使用简单的字符串 ID（如 `gene_<name>`、`capsule_<timestamp>`），不符合协议要求。

**协议要求：**
```json
{
  "type": "Gene",
  "asset_id": "sha256:abc123...",  // 内容哈希，排除asset_id字段本身
  ...
}
```

**改进方案：**
1. 添加 `AssetIdGenerator` 类，实现 SHA-256 内容哈希生成
2. 修改 `GepAssetStore` 在存储前自动计算 asset_id
3. 确保哈希计算时排除 `asset_id` 字段本身（canonical JSON 序列化）
4. 提供向后兼容的迁移机制

**优先级：** 🔴 高

---

### 1.2 当前问题：GEP-A2A 协议消息信封缺失

**问题描述：**
GEP-A2A 协议定义了 **七字段强制信封结构**，当前实现完全没有实现网络通信层，仅支持本地 SQLite 存储。

**协议要求的信封结构：**
```json
{
  "protocol": "gep-a2a",
  "protocol_version": "1.0.0",
  "message_type": "hello|publish|fetch|report|decision|revoke",
  "message_id": "msg_<timestamp>_<random>",
  "sender_id": "node_<8字节随机十六进制>",
  "timestamp": "2026-02-25T14:21:20.244Z",
  "payload": { ... }
}
```

**改进方案：**
1. 实现 `GepA2AProtocol` 类，封装协议信封的创建和验证
2. 实现 `sender_id` 的持久化机制（本地生成并存储）
3. 添加消息类型枚举和验证
4. 为未来的网络同步功能奠定基础

**优先级：** 🟡 中（当前为单机版，网络功能为扩展）

---

### 1.3 当前问题：Capsule 结构不符合协议规范

**问题描述：**
根据协议，Capsule 必须包含以下字段：`trigger`, `gene`, `summary`, `content`, `confidence`, `blast_radius`, `outcome`, `env_fingerprint`, `success_streak`, `asset_id`。当前实现缺少 `content`, `outcome`, `env_fingerprint`, `success_streak` 等关键字段。

**改进方案：**
1. 扩展 Capsule 数据结构，添加缺失字段
2. 在 `solidify` 流程中自动捕获 `env_fingerprint`
3. 实现 `success_streak` 计数逻辑（基于相同 gene 和信号的历史成功率）
4. 添加 `outcome` 验证（status + score）

**优先级：** 🔴 高

---

### 1.4 当前问题：EvolutionEvent 结构不完整

**问题描述：**
协议要求的 EvolutionEvent 包含 `mutations_tried`, `total_cycles` 等统计字段，当前实现缺失。

**改进方案：**
1. 扩展 EvolutionEvent 结构
2. 在进化循环中跟踪突变尝试次数和周期数
3. 记录完整的基因血统链（genes_used）

**优先级：** 🟢 低

---

## 二、安全模型强化

### 2.1 当前问题：源码保护机制缺失

**问题描述：**
根据协议，核心进化引擎应该不可自覆盖（Immutable），防止"自我毁灭"场景。当前实现没有这种保护。

**改进方案：**
1. 实现 `SourceProtector` 类，定义受保护的核心文件列表
2. 在 `solidify` 流程中添加保护检查
3. 支持配置保护路径（默认保护 `src/` 核心文件）
4. 提供紧急绕过机制（仅供测试）

**优先级：** 🔴 高

---

### 2.2 当前问题：环境变量控制不完善

**问题描述：**
协议要求 `EVOLVE_ALLOW_SELF_MODIFY` 环境变量有三个取值：`never`, `review`, `always`。当前实现没有此控制机制。

**改进方案：**
1. 添加 `SafetyController` 类，读取环境变量
2. 实现三种模式的行为差异：
   - `never`: 仅允许诊断和建议，禁止任何修改
   - `review`: 所有修改需人工确认
   - `always`: 完全自动化（默认）
3. 在 MCP 工具层面强制执行

**优先级：** 🟡 中

---

### 2.3 当前问题：修复循环检测不完善

**问题描述：**
当前实现有基本的修复循环检测（3次连续修复触发警告），但缺乏更复杂的振荡模式识别。

**改进方案：**
1. 增强 `SignalExtractor` 的循环检测逻辑
2. 检测指标：
   - 相同文件的反复修改
   - 相同问题的反复出现
   - 成功率的持续下降
3. 触发升级处理：暂停自动突变、通知人工审查

**优先级：** 🟡 中

---

## 三、网络与生态集成

### 3.1 当前问题：完全缺乏网络功能

**问题描述：**
当前实现是纯本地单机版，没有实现任何 GEP-A2A 网络功能，无法参与 EvoMap 生态。

**协议要求的网络功能：**
- 节点注册（hello 消息）
- 心跳机制（15分钟间隔）
- 资产发布（publish）
- 资产查询（fetch）
- 进化事件同步

**改进方案：**
1. 实现 `EvoMapClient` 类，封装 HTTP API 调用
2. 实现节点注册和设备 ID 持久化
3. 添加心跳定时器（可选后台进程）
4. 实现资产发布和查询功能
5. 支持离线模式（本地缓存，恢复后同步）

**优先级：** 🟡 中（取决于产品定位）

---

### 3.2 当前问题：GDI 评分系统缺失

**问题描述：**
GDI（Genome Distribution Index）是协议定义的资产质量评分系统，当前实现没有此概念。

**GDI 评分因素：**
- 置信度评分（confidence）
- 影响范围（blast_radius）
- 连续成功次数（success_streak）
- 环境指纹匹配度
- 是否包含 EvolutionEvent

**改进方案：**
1. 实现 `GdiCalculator` 类
2. 在 Capsule 创建时计算初始 GDI
3. 在资产查询时支持按 GDI 排序
4. 定期更新 GDI（基于新的验证数据）

**优先级：** 🟢 低

---

## 四、运行时模式扩展

### 4.1 当前问题：缺乏守护进程模式

**问题描述：**
协议定义了三种运行时模式：标准模式、审查模式、持续循环模式。当前仅实现了类似标准模式的 MCP 服务。

**改进方案：**
1. 实现 `--review` 审查模式：所有修改需人工确认
2. 实现 `--loop` 持续循环模式：后台守护进程，定时执行进化
3. 添加 `--daemon` 参数支持进程管理
4. 集成进程管理工具（如 systemd、supervisor）

**优先级：** 🟡 中

---

### 4.2 当前问题：策略参数调优接口缺失

**问题描述：**
协议支持细粒度的策略参数调优，当前实现仅支持四种预设策略。

**改进方案：**
1. 添加 `StrategyConfig` 类，支持：
   - 各类突变的权重系数
   - 质量门控阈值
   - 冷却期时长
   - 影响范围限制
2. 支持配置文件（`.evolver.json`）
3. 支持运行时策略切换

**优先级：** 🟢 低

---

## 五、数据模型与存储优化

### 5.1 当前问题：数据库 Schema 不完整

**改进方案：**
1. 添加 `asset_id` 字段索引
2. 添加 `env_fingerprint` 存储（JSON 格式）
3. 添加 `success_streak` 计数器
4. 添加 `gdi_score` 字段
5. 添加 `sync_status` 字段（用于网络同步状态跟踪）

**优先级：** 🟡 中

---

### 5.2 当前问题：缺乏数据迁移机制

**改进方案：**
1. 实现数据库版本管理（`schema_version` 表）
2. 提供迁移脚本（`evolver.php --migrate`）
3. 支持从旧版本自动升级

**优先级：** 🟢 低

---

## 六、运维与监控

### 6.1 当前问题：运维模块缺失

**问题描述：**
原协议定义了丰富的运维模块（`src/ops/`），当前实现完全没有。

**需要实现的运维工具：**
1. **生命周期管理**（Lifecycle Manager）：启动、监控、优雅终止
2. **技能健康监控**（Skill Health Monitor）：定期探针测试
3. **磁盘清理**（Disk Cleaner）：日志和缓存管理
4. **Git 自修复**（Git Self-Repair）：版本控制异常处理
5. **网络同步**（Network Sync）：与 EvoMap 的数据交换
6. **信号去重**（Signal Deduplicator）：防止报警风暴

**改进方案：**
1. 创建 `src/Ops/` 命名空间
2. 逐个实现上述运维工具
3. 提供统一的运维命令接口（`evolver.php --ops <command>`）

**优先级：** 🟡 中

---

### 6.2 当前问题：日志与审计不完善

**改进方案：**
1. 实现结构化日志（JSON Lines 格式）
2. 添加日志轮转和压缩
3. 实现审计日志（所有进化操作的完整记录）
4. 支持日志级别配置

**优先级：** 🟢 低

---

## 七、测试与质量保证

### 7.1 当前问题：测试覆盖不足

**改进方案：**
1. 添加单元测试（目标覆盖率 >80%）
2. 添加集成测试（完整进化流程）
3. 添加协议合规性测试（验证 GEP 输出格式）
4. 添加安全测试（验证保护机制）
5. 添加性能测试（大规模基因/胶囊查询）

**优先级：** 🟡 中

---

### 7.2 当前问题：缺少协议验证工具

**改进方案：**
1. 实现 `evolver.php --validate-gep` 命令
2. 验证输出的 5 个 GEP 对象格式
3. 验证 asset_id 计算正确性
4. 验证环境指纹完整性

**优先级：** 🟡 中

---

## 八、实施计划

### 阶段一：核心协议合规（2-3 周）

**目标：** 使 Evolver.php 符合 GEP 协议核心要求

**任务清单：**
- [ ] 实现 SHA-256 asset_id 生成机制
- [ ] 完善 Capsule 数据结构（添加缺失字段）
- [ ] 完善 EvolutionEvent 结构
- [ ] 实现源码保护机制
- [ ] 更新数据库 Schema
- [ ] 添加协议验证工具

**交付物：**
- 符合 GEP 1.5.0 规范的资产存储
- 完整的协议验证测试

---

### 阶段二：安全与稳定性（1-2 周）

**目标：** 强化安全模型，防止自我毁灭

**任务清单：**
- [ ] 实现 `EVOLVE_ALLOW_SELF_MODIFY` 环境变量控制
- [ ] 增强修复循环检测
- [ ] 添加 blast radius 硬限制检查
- [ ] 实现验证命令白名单
- [ ] 添加安全审计日志

**交付物：**
- 安全控制文档
- 安全测试用例

---

### 阶段三：网络功能（2-3 周）

**目标：** 实现 GEP-A2A 网络协议基础

**任务清单：**
- [ ] 实现 GEP-A2A 消息信封
- [ ] 实现 EvoMap HTTP 客户端
- [ ] 实现节点注册和心跳
- [ ] 实现资产发布和查询
- [ ] 实现离线模式支持

**交付物：**
- 网络功能模块
- 网络集成测试

---

### 阶段四：运维工具（2 周）

**目标：** 实现生产环境所需的运维工具

**任务清单：**
- [ ] 实现生命周期管理器
- [ ] 实现磁盘清理工具
- [ ] 实现健康监控
- [ ] 实现信号去重
- [ ] 添加运维命令接口

**交付物：**
- 运维模块
- 运维文档

---

### 阶段五：运行时模式（1-2 周）

**目标：** 支持多种运行时模式

**任务清单：**
- [ ] 实现审查模式（`--review`）
- [ ] 实现持续循环模式（`--loop`）
- [ ] 实现守护进程支持
- [ ] 添加策略配置文件支持

**交付物：**
- 多模式运行时支持
- 配置文档

---

### 阶段六：测试与优化（持续）

**目标：** 提高代码质量和性能

**任务清单：**
- [ ] 完善单元测试覆盖
- [ ] 添加性能测试
- [ ] 优化数据库查询
- [ ] 添加基准测试
- [ ] 性能调优

**交付物：**
- 测试报告
- 性能基准

---

## 九、优先级总结

| 优先级 | 问题/功能 | 阶段 |
|--------|-----------|------|
| 🔴 高 | Asset ID 生成机制 | 阶段一 |
| 🔴 高 | Capsule 结构完善 | 阶段一 |
| 🔴 高 | 源码保护机制 | 阶段二 |
| 🟡 中 | GEP-A2A 协议信封 | 阶段三 |
| 🟡 中 | 网络功能（EvoMap 集成） | 阶段三 |
| 🟡 中 | 运维模块 | 阶段四 |
| 🟡 中 | 运行时模式扩展 | 阶段五 |
| 🟢 低 | GDI 评分系统 | 可选 |
| 🟢 低 | 数据迁移机制 | 可选 |
| 🟢 低 | 高级日志与审计 | 可选 |

---

## 十、参考文档

1. [EvoMap/evolver 深度技术研究报告](https://zhichai.top/topic/177168577) - zhichai
2. [EvoMap/evolver GitHub](https://github.com/EvoMap/evolver) - 官方仓库
3. GEP Protocol Specification v1.5.0
4. MCP Protocol Specification

---

*文档版本：1.0*  
*最后更新：2026-02-25*  
*作者：AI Assistant*
