# Evolver.php 改进实施总结

## 概述

本文档总结了按照《改进方案和计划.md》对 Evolver.php 进行的全面改进实施。

---

## 已完成的改进

### ✅ 阶段一：核心协议合规 (GEP 1.6.0)

#### 1.1 SHA-256 Asset ID 生成机制
**文件**: `src/ContentHash.php`

- 实现了 `canonicalize()` 方法，提供确定性 JSON 序列化
- 实现了 `computeAssetId()` 方法，生成 `sha256:<hex>` 格式的内容哈希
- 实现了 `verifyAssetId()` 方法，验证资产 ID 与内容匹配
- 支持排除字段（如 asset_id 本身）不参与哈希计算

```php
$assetId = ContentHash::computeAssetId($gene);
// 返回: sha256:abc123...
```

#### 1.2 完善 Capsule 数据结构
**文件**: `src/GepAssetStore.php`, `src/SolidifyEngine.php`

新增字段：
- `asset_id` - SHA-256 内容哈希
- `content` - 解决方案内容（最多 8000 字符）
- `outcome` - 执行结果（status + score）
- `env_fingerprint` - 环境指纹
- `success_streak` - 连续成功次数
- `schema_version` - 模式版本

#### 1.3 完善 EvolutionEvent 结构
新增字段：
- `asset_id` - 事件的内容哈希
- `mutations_tried` - 尝试的突变次数
- `total_cycles` - 总迭代周期数
- `env_fingerprint` - 环境指纹

#### 1.4 数据库 Schema 迁移
**文件**: `src/GepAssetStore.php`

自动迁移支持：
- `genes` 表添加 `asset_id`, `schema_version` 字段
- `capsules` 表添加 `asset_id`, `outcome_status`, `outcome_score`, `env_fingerprint`, `success_streak`, `content` 字段
- `events` 表添加 `env_fingerprint`, `mutations_tried`, `total_cycles` 字段
- 新增 `sync_status` 表用于网络同步状态跟踪

---

### ✅ 阶段二：安全模型强化

#### 2.1 源码保护机制
**文件**: `src/SourceProtector.php`

功能：
- 定义受保护的核心文件列表（`src/McpServer.php`, `src/Database.php` 等）
- 支持通配符模式匹配（`src/Ops/*.php`, `vendor/*`）
- 提供 `validateFiles()` 和 `assertSafe()` 方法
- 支持紧急绕过（`EVOLVER_BYPASS_PROTECTION=1`）

```php
$protector = new SourceProtector();
$protector->assertSafe(['user_file.php']); // 如果包含受保护文件则抛出异常
```

#### 2.2 环境变量控制
**文件**: `src/SafetyController.php`

支持三种模式：
- `never` - 完全禁止自修改，仅允许诊断
- `review` - 所有修改需人工确认
- `always` - 完全自动化（默认）

```bash
EVOLVE_ALLOW_SELF_MODIFY=never php evolver.php
```

#### 2.3 增强修复循环检测
**文件**: `src/SignalExtractor.php`

新增检测指标：
- 连续修复计数（阈值：3次警告，5次强制创新）
- 空周期检测（阈值：3次）
- 失败率检测（阈值：60%）
- 信号振荡检测
- 文件修改抖动检测

---

### ✅ 阶段三：网络与生态集成

#### 3.1 GEP-A2A 协议实现
**文件**: `src/GepA2AProtocol.php`

实现的消息类型：
- `hello` - 节点注册和能力通告
- `publish` - 资产发布（支持单资产和 bundle）
- `fetch` - 资产查询
- `report` - 验证报告
- `decision` - 接受/拒绝/隔离决策
- `revoke` - 撤销已发布资产

协议信封结构：
```json
{
  "protocol": "gep-a2a",
  "protocol_version": "1.0.0",
  "message_type": "hello",
  "message_id": "msg_<timestamp>_<random>",
  "sender_id": "node_<hash>",
  "timestamp": "2026-02-25T14:21:20Z",
  "payload": { ... }
}
```

#### 3.2 EvoMap HTTP 客户端
**文件**: `src/EvoMapClient.php`

功能：
- 节点注册（`sendHello()`）
- 心跳维护（`sendHeartbeat()`）
- 资产发布（`publishAsset()`, `publishBundle()`）
- 资产查询（`fetchAssets()`, `searchAssets()`）
- 验证报告（`reportValidation()`）
- 决策提交（`sendDecision()`）

配置：
```bash
export A2A_HUB_URL=https://evomap.ai
export A2A_NODE_SECRET=your_secret
```

---

### ✅ 阶段四：运维模块

#### 4.1 生命周期管理器
**文件**: `src/Ops/LifecycleManager.php`

功能：
- 启动/关闭事件处理
- 进程信号处理（SIGTERM, SIGINT）
- 健康状态监控
- 指标收集（周期数、成功率等）

#### 4.2 磁盘清理器
**文件**: `src/Ops/DiskCleaner.php`

功能：
- 日志文件轮转和压缩
- 旧事件归档
- 临时文件清理
- 磁盘空间监控

配置：
```php
[
    'max_log_age_days' => 7,
    'max_event_age_days' => 30,
    'max_temp_age_hours' => 24,
    'min_free_space_mb' => 100,
]
```

#### 4.3 信号去重器
**文件**: `src/Ops/SignalDeduplicator.php`

功能：
- 信号指纹计算（归一化 + 哈希）
- 抑制窗口管理（默认1小时）
- 周期性汇总报告
- 防止通知风暴

---

## MCP 工具扩展

**文件**: `src/McpServer.php`

新增工具：
- `evolver_safety_status` - 获取安全状态
- `evolver_cleanup` - 运行清理操作
- `evolver_sync_to_hub` - 同步到 EvoMap Hub

新增资源：
- `gep://safety` - 安全状态信息

---

## 测试覆盖

**文件**: `tests/EvolverTest.php`

新增测试（69个测试，228个断言）：
- `ContentHash` 测试（4个）
- `SourceProtector` 测试（3个）
- `SafetyController` 测试（3个）
- `GepA2AProtocol` 测试（3个）
- `SignalDeduplicator` 测试（2个）

---

## 文件变更清单

### 新增文件
```
src/ContentHash.php           # SHA-256 内容哈希
src/SourceProtector.php       # 源码保护机制
src/SafetyController.php      # 安全控制器
src/GepA2AProtocol.php        # GEP-A2A 协议
src/EvoMapClient.php          # EvoMap HTTP 客户端
src/Ops/LifecycleManager.php  # 生命周期管理
src/Ops/DiskCleaner.php       # 磁盘清理
src/Ops/SignalDeduplicator.php # 信号去重
```

### 修改文件
```
src/McpServer.php             # 集成新功能，新增工具
src/GepAssetStore.php         # 支持 GEP 1.6.0，自动迁移
src/SolidifyEngine.php        # 完善数据结构
src/SignalExtractor.php       # 增强循环检测
tests/EvolverTest.php         # 新增测试用例
```

---

## 使用示例

### 检查安全状态
```json
{
  "name": "evolver_safety_status",
  "arguments": {}
}
```

### 运行清理
```json
{
  "name": "evolver_cleanup",
  "arguments": {}
}
```

### 同步到 Hub
```json
{
  "name": "evolver_sync_to_hub",
  "arguments": {}
}
```

### 使用安全模式运行
```bash
# 禁止自修改
EVOLVE_ALLOW_SELF_MODIFY=never php evolver.php

# 审查模式
EVOLVE_ALLOW_SELF_MODIFY=review php evolver.php

# 完全自动化（默认）
EVOLVE_ALLOW_SELF_MODIFY=always php evolver.php
```

---

## 协议合规性

| 协议要求 | 状态 | 实现文件 |
|---------|------|---------|
| SHA-256 asset_id | ✅ | `ContentHash.php` |
| GEP-A2A 信封 | ✅ | `GepA2AProtocol.php` |
| 环境指纹 | ✅ | `EnvFingerprint.php` |
| 源码保护 | ✅ | `SourceProtector.php` |
| 安全模式控制 | ✅ | `SafetyController.php` |
| 修复循环检测 | ✅ | `SignalExtractor.php` |
| 网络同步 | ✅ | `EvoMapClient.php` |
| 运维工具 | ✅ | `Ops/*.php` |

---

## 后续建议

1. **完善网络功能**：实现离线模式支持，本地缓存和延迟同步
2. **GDI 评分**：实现完整的 Genome Distribution Index 计算
3. **运行时模式**：实现 `--review` 和 `--loop` 命令行模式
4. **更多运维工具**：健康监控、Git 自修复等
5. **性能优化**：大规模基因/胶囊查询优化

---

*文档版本：1.0*  
*最后更新：2026-02-25*  
*改进实施：AI Assistant*
