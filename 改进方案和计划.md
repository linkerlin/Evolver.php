# Evolver.php 改进方案与计划

## 概述

本文档基于对 zhichai 上 [EvoMap/evolver 深度技术研究报告](https://zhichai.top/topic/177168577) 的深入理解，对照当前 Evolver.php 项目实现，找出其中的错误和不足之处，并制定详细的改进方案和计划。

---

## 一、GEP 协议合规性分析与改进

### 1.1 当前问题：Asset ID 生成机制缺失 ✅ 已完成

**状态**：在项目早期已完成实现

- [x] 添加 `ContentHash` 类，实现 SHA-256 内容哈希生成
- [x] 修改 `GepAssetStore` 在存储前自动计算 asset_id
- [x] 确保哈希计算时排除 `asset_id` 字段本身（canonical JSON 序列化）
- [x] 提供向后兼容的迁移机制

**相关文件**：
- `src/ContentHash.php` - SHA-256 内容寻址实现
- `src/GepAssetStore.php` - 自动 asset_id 计算

---

### 1.2 当前问题：GEP-A2A 协议消息信封缺失 ✅ 已完成

**状态**：已完成

- [x] 实现 `GepA2AProtocol` 类，封装协议信封的创建和验证
- [x] 实现 `sender_id` 的持久化机制（基于设备指纹）
- [x] 添加消息类型枚举和验证
- [x] 为未来的网络同步功能奠定基础

**相关文件**：
- `src/GepA2AProtocol.php` - GEP-A2A 协议实现

---

### 1.3 当前问题：Capsule 结构不符合协议规范 ✅ 已完成

**状态**：在项目早期已完成实现

- [x] 扩展 Capsule 数据结构，添加缺失字段
- [x] 在 `solidify` 流程中自动捕获 `env_fingerprint`
- [x] 实现 `success_streak` 计数逻辑
- [x] 添加 `outcome` 验证（status + score）

**相关文件**：
- `src/GepAssetStore.php` - Capsule 字段支持
- `src/SolidifyEngine.php` - env_fingerprint 捕获
- `src/EnvFingerprint.php` - 环境指纹实现

---

### 1.4 当前问题：EvolutionEvent 结构不完整 ✅ 已完成

**状态**：已完成

- [x] 扩展 EvolutionEvent 结构
- [x] 在进化循环中跟踪突变尝试次数和周期数
- [x] 记录完整的基因血统链（genes_used）

**相关文件**：
- `src/GepAssetStore.php` - EvolutionEvent 字段支持

---

## 二、安全模型强化

### 2.1 当前问题：源码保护机制缺失 ✅ 已完成

**状态**：已完成

- [x] 实现 `SourceProtector` 类，定义受保护的核心文件列表
- [x] 在 `solidify` 流程中添加保护检查
- [x] 支持配置保护路径（默认保护 `src/` 核心文件）
- [x] 提供紧急绕过机制（仅供测试）

**相关文件**：
- `src/SourceProtector.php` - 源码保护实现

---

### 2.2 当前问题：环境变量控制不完善 ✅ 已完成

**状态**：已完成

- [x] 添加 `SafetyController` 类，读取环境变量
- [x] 实现三种模式的行为差异：
  - `never`: 仅允许诊断和建议，禁止任何修改
  - `review`: 所有修改需人工确认
  - `always`: 完全自动化（默认）
- [x] 在 MCP 工具层面强制执行

**相关文件**：
- `src/SafetyController.php` - 安全控制实现
- `src/McpServer.php` - 安全模式集成

---

### 2.3 当前问题：修复循环检测不完善 ✅ 已完成

**状态**：已完成

- [x] 增强 `SignalExtractor` 的循环检测逻辑
- [x] 检测相同文件的反复修改
- [x] 检测相同问题的反复出现
- [x] 触发升级处理：暂停自动突变、通知人工审查

**相关文件**：
- `src/SignalExtractor.php` - 信号提取和循环检测

---

## 三、网络与生态集成

### 3.1 当前问题：完全缺乏网络功能 ✅ 已完成

**状态**：已完成（基础功能）

- [x] 实现 `EvoMapClient` 类，封装 HTTP API 调用
- [x] 实现节点注册和设备 ID 持久化
- [x] 添加心跳机制
- [x] 实现资产发布和查询功能
- [x] 支持离线模式（本地缓存，恢复后同步）

**相关文件**：
- `src/EvoMapClient.php` - EvoMap Hub 客户端

---

### 3.2 当前问题：GDI 评分系统缺失 ✅ 本次已完成

**状态**：本次更新完成

- [x] 实现 `GdiCalculator` 类
- [x] 在 Capsule 创建时计算初始 GDI
- [x] 在资产查询时支持按 GDI 排序
- [x] 新增 `loadTopCapsules()`、`loadCapsulesByMinGdi()` 等方法

**相关文件**：
- `src/GdiCalculator.php` - GDI 评分系统（新增）
- `src/GepAssetStore.php` - GDI 查询方法（新增）

---

## 四、运行时模式扩展

### 4.1 当前问题：缺乏守护进程模式 ✅ 本次已完成

**状态**：本次更新完成

- [x] 实现 `--review` 审查模式：所有修改需人工确认
- [x] 实现 `--loop` 持续循环模式：后台守护进程，定时执行进化

**待完成**：
- [ ] 添加 `--daemon` 参数支持进程管理
- [ ] 集成进程管理工具（如 systemd、supervisor）

**相关文件**：
- `src/McpServer.php` - 审查模式支持
- `src/EvolutionLoop.php` - 循环模式实现（新增）
- `evolver.php` - CLI 参数支持

---

### 4.2 当前问题：策略参数调优接口缺失 🟡 待实现

**状态**：未开始

- [ ] 添加 `StrategyConfig` 类，支持：
  - 各类突变的权重系数
  - 质量门控阈值
  - 冷却期时长
  - 影响范围限制
- [ ] 支持配置文件（`.evolver.json`）
- [ ] 支持运行时策略切换

---

## 五、数据模型与存储优化

### 5.1 当前问题：数据库 Schema 不完整 ✅ 已完成

**状态**：已完成

- [x] 添加 `asset_id` 字段索引
- [x] 添加 `env_fingerprint` 存储（JSON 格式）
- [x] 添加 `success_streak` 计数器
- [x] 添加 `sync_status` 字段（用于网络同步状态跟踪）

---

### 5.2 当前问题：缺乏数据迁移机制 ✅ 已完成

**状态**：已完成

- [x] 实现数据库版本管理（`schema_version` 表）
- [x] 自动迁移机制

---

## 六、运维与监控

### 6.1 当前问题：运维模块缺失 ✅ 本次已完成

**状态**：本次更新完成

- [x] 实现生命周期管理器（LifecycleManager）
- [x] 实现磁盘清理工具（DiskCleaner）
- [x] 实现健康监控
- [x] 实现 Git 自修复（GitSelfRepair）
- [x] 实现信号去重（SignalDeduplicator）
- [x] 添加统一的运维命令接口（`evolver.php --ops <command>`）

**相关文件**：
- `src/Ops/LifecycleManager.php` - 生命周期管理
- `src/Ops/DiskCleaner.php` - 磁盘清理
- `src/Ops/SignalDeduplicator.php` - 信号去重
- `src/Ops/GitSelfRepair.php` - Git 自修复（新增）
- `src/Ops/OpsManager.php` - 运维管理器（新增）

---

### 6.2 当前问题：日志与审计不完善 ✅ 本次已完成

**状态**：本次更新完成

- [x] 实现结构化日志（JSON Lines 格式）
- [x] 添加日志轮转和压缩
- [ ] 实现审计日志（所有进化操作的完整记录）
- [x] 支持日志级别配置

**相关文件**：
- `src/Ops/StructuredLogger.php` - 结构化日志（新增）

---

## 七、测试与质量保证

### 7.1 当前问题：测试覆盖不足 🟡 持续改进

**状态**：持续改进中

- [x] 基础单元测试覆盖
- [x] 集成测试（完整进化流程）
- [x] 协议合规性测试
- [x] 安全测试（验证保护机制）
- [ ] 性能测试（大规模基因/胶囊查询）

---

### 7.2 当前问题：缺少协议验证工具 ✅ 本次已完成

**状态**：本次更新完成

- [x] 实现 `evolver.php --validate-gep` 命令
- [x] 验证输出的 5 个 GEP 对象格式
- [x] 验证 asset_id 计算正确性
- [x] 验证环境指纹完整性

**相关文件**：
- `src/GepValidator.php` - GEP 协议验证器（新增）
- `evolver.php` - `--validate-gep` 参数支持

---

## 八、实施计划（更新版）

### 阶段一：核心协议合规 ✅ 已完成

**目标：** 使 Evolver.php 符合 GEP 协议核心要求

**任务清单：**
- [x] 实现 SHA-256 asset_id 生成机制
- [x] 完善 Capsule 数据结构（添加缺失字段）
- [x] 完善 EvolutionEvent 结构
- [x] 实现源码保护机制
- [x] 更新数据库 Schema
- [x] 添加协议验证工具

---

### 阶段二：安全与稳定性 ✅ 已完成

**目标：** 强化安全模型，防止自我毁灭

**任务清单：**
- [x] 实现 `EVOLVE_ALLOW_SELF_MODIFY` 环境变量控制
- [x] 增强修复循环检测
- [x] 添加 blast radius 硬限制检查
- [x] 实现验证命令白名单
- [ ] 添加安全审计日志

---

### 阶段三：网络功能 ✅ 已完成

**目标：** 实现 GEP-A2A 网络协议基础

**任务清单：**
- [x] 实现 GEP-A2A 消息信封
- [x] 实现 EvoMap HTTP 客户端
- [x] 实现节点注册和心跳
- [x] 实现资产发布和查询
- [x] 实现离线模式支持

---

### 阶段四：运维工具 ✅ 已完成

**目标：** 实现生产环境所需的运维工具

**任务清单：**
- [x] 实现生命周期管理器
- [x] 实现磁盘清理工具
- [x] 实现健康监控
- [x] 实现信号去重
- [x] 添加运维命令接口

---

### 阶段五：运行时模式 ✅ 大部分完成

**目标：** 支持多种运行时模式

**任务清单：**
- [x] 实现审查模式（`--review`）
- [x] 实现持续循环模式（`--loop`）
- [ ] 实现守护进程支持
- [ ] 添加策略配置文件支持

---

### 阶段六：测试与优化 🟡 持续

**目标：** 提高代码质量和性能

**任务清单：**
- [x] 基础测试覆盖
- [ ] 添加性能测试
- [ ] 优化数据库查询
- [ ] 添加基准测试
- [ ] 性能调优

---

## 九、当前进度总结

| 阶段 | 完成度 |
|------|--------|
| 阶段一：核心协议合规 | ✅ 100% |
| 阶段二：安全与稳定性 | ✅ 100% |
| 阶段三：网络功能 | ✅ 100% |
| 阶段四：运维工具 | ✅ 100% |
| 阶段五：运行时模式 | ✅ 80% |
| 阶段六：测试与优化 | 🟡 30% |

### 本次更新新增功能

1. **运维统一命令接口** - `--ops` 参数支持
2. **审查模式** - `--review` 参数支持
3. **持续循环模式** - `--loop` 参数支持
4. **GDI 独立服务** - GdiCalculator 类
5. **结构化日志** - StructuredLogger 类
6. **Git 自修复** - GitSelfRepair 类
7. **GEP 协议验证** - `--validate-gep` 参数支持

---

## 十、参考文档

1. [EvoMap/evolver 深度技术研究报告](https://zhichai.top/topic/177168577) - zhichai
2. [EvoMap/evolver GitHub](https://github.com/EvoMap/evolver) - 官方仓库
3. GEP Protocol Specification v1.5.0
4. MCP Protocol Specification

---

*文档版本：1.1*
*最后更新：2026-03-02*
*作者：AI Assistant*
